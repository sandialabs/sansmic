name: Semantic Release

on:
  workflow_dispatch:
    inputs:
      is_prerelease:
        description: 'Is this a prerelease?'
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  semantic-release:
    name: Check if new release 🔖 needed ❔
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    environment:
      name: sem-ver
    concurrency: release
    
    outputs:
      is_prerelease: ${{ steps.semantic_release.outputs.is_prerelease }}
      released: ${{ steps.semantic_release.outputs.released }}
      version: ${{ steps.semantic_release.outputs.version }}
      tag: ${{ steps.semantic_release.outputs.tag }}

    permissions:
      id-token: write
      contents: write

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
      with:
        egress-policy: audit

    - name: Debug | Input variables
      run: |
        echo "## Inputs" >> $GITHUB_STEP_SUMMARY
        echo "Is prerelease - " ${{ inputs.is_prerelease }} | tee $GITHUB_STEP_SUMMARY

    - name: Setup | Checkout Repository at workflow sha
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        token: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
        fetch-depth: 0
        ref: ${{ github.sha }}
    - name: Setup | Force correct release branch on workflow sha
      run: git checkout -B ${{ github.ref_name }} ${{ github.sha }}

    - name: Setup | Get short commit SHA
      id: vars
      run: echo "short_sha=$(git rev-parse --short HEAD)\n" >> $GITHUB_OUTPUT

    - name: Action | Semantic Release - Update version
      id: semantic_release
      # Adjust tag with desired version if applicable.
      uses: python-semantic-release/python-semantic-release@5b9d941d5b29da138b933660ce1a9df75b54ce25 # v10.3.1
      with:
        github_token: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
        git_committer_name: "github-actions"
        git_committer_email: "actions@users.noreply.github.com"
        build: false
        changelog: true
        commit: true
        push: true
        tag: true
        prerelease: ${{ inputs.is_prerelease }}
        vcs_release: true

    - name: Action | Output version info
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Results of python-semantic-version" >> $GITHUB_STEP_SUMMARY
        echo "Released " ${{ steps.semantic_release.outputs.released }} >> $GITHUB_STEP_SUMMARY
        echo "Prerelease " ${{ steps.semantic_release.outputs.is_prerelease }} >> $GITHUB_STEP_SUMMARY
        echo "Version " ${{ steps.semantic_release.outputs.version }} >> $GITHUB_STEP_SUMMARY
        echo "Tag " ${{ steps.semantic_release.outputs.tag }} >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
